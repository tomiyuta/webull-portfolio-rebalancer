# Webull Portfolio Rebalancer Bot - 変更履歴

## v1.5.0 - 総資産価値ベースリバランス機能の追加

### 🚀 新機能

#### 1. 総資産価値ベースリバランス
- **効率的な資金活用**: 既存ポジションを含む総資産価値を使用
- **段階的リバランス**: 売却→購入の2段階で安全に実行
- **自動ポジション売却**: 目標配分に含まれない銘柄の自動売却
- **過剰ポジション調整**: 目標配分を超えるポジションの自動調整

#### 2. リバランスモード選択
- **総資産価値ベース**: デフォルトの改善されたリバランス方式
- **利用可能資金ベース**: 従来のリバランス方式
- **コマンドラインオプション**: `--mode`でモード選択可能

#### 3. 高度な取引計算
- **売却取引計算**: `calculate_sell_trades()`で既存ポジションの売却を計算
- **購入取引計算**: `calculate_buy_trades()`で新規購入を計算
- **資金効率最適化**: 残り資金を最大限活用

### 🔧 技術的改善

#### 1. リバランスロジックの改善
- **`calculate_target_allocation_total_value()`**: 総資産価値ベースの目標配分計算
- **`calculate_sell_trades()`**: 売却取引の詳細計算
- **`calculate_buy_trades()`**: 購入取引の詳細計算
- **`rebalance_total_value()`**: 新しいリバランスメソッド

#### 2. 設定オプションの拡張
- **`rebalancing_settings`**: リバランスモードとパラメータの詳細設定
- **`mode`**: リバランス方式の選択
- **`include_existing_positions`**: 既存ポジションの活用設定
- **`sell_existing_positions`**: 既存ポジションの売却設定

#### 3. 実行オプションの追加
- **`run_rebalancing.py`**: `--mode`オプションでリバランスモード選択
- **デフォルトモード**: 総資産価値ベースリバランス
- **従来モード**: `--mode available_cash`で利用可能資金ベース

### 📝 ドキュメント更新

#### 1. README.md
- **リバランスモード説明**: 2つのリバランス方式の詳細説明
- **実行方法**: モード選択オプションの使用方法
- **設定例**: リバランス設定の詳細なサンプル
- **比較表**: 従来方式と改善方式の効果比較

#### 2. 設定ファイル例
- **`rebalancing_settings`**: 新しいリバランス設定セクション
- **モード選択**: `total_value`と`available_cash`の設定例
- **パラメータ調整**: 取引金額制限とリバランス閾値の設定

### 🧪 テスト済み機能

#### 1. リバランスモードテスト
- **総資産価値ベース**: 既存ポジションを含む効率的なリバランス
- **利用可能資金ベース**: 従来のリバランス方式
- **モード切り替え**: コマンドラインオプションでの切り替え

#### 2. 機能テスト結果
- ✅ 総資産価値ベース目標配分計算
- ✅ 売却取引計算
- ✅ 購入取引計算
- ✅ 段階的リバランス実行
- ✅ 自動ポジション売却
- ✅ 過剰ポジション調整
- ✅ リバランスモード切り替え

### 🔄 変更されたファイル

#### 1. 更新されたファイル
- `webull_complete_rebalancer.py`: 総資産価値ベースリバランス機能を追加
- `run_rebalancing.py`: リバランスモード選択オプションを追加
- `README.md`: 新しいリバランス機能の説明を追加
- `webull_config_sample.json`: リバランス設定を追加
- `webull_config_with_allocation.json`: リバランス設定を追加

### 📋 使用方法

#### 1. 総資産価値ベースリバランス（デフォルト）
```bash
# Docker実行
docker run --rm -v $(pwd):/app webullbot python3 run_rebalancing.py

# 手動実行
python run_rebalancing.py
```

#### 2. 利用可能資金ベースリバランス（従来方式）
```bash
# Docker実行
docker run --rm -v $(pwd):/app webullbot python3 run_rebalancing.py --mode available_cash

# 手動実行
python run_rebalancing.py --mode available_cash
```

#### 3. 設定ファイルでのリバランスモード指定
```json
{
  "rebalancing_settings": {
    "mode": "total_value",
    "include_existing_positions": true,
    "sell_existing_positions": true,
    "min_trade_amount": 100,
    "max_trade_amount": 10000,
    "rebalance_threshold": 0.05
  }
}
```

### 🎯 改善効果

#### 従来方式 vs 改善方式の比較

| 項目 | 従来方式 | 改善方式 |
|------|----------|----------|
| **資金使用** | 利用可能資金のみ | 総資産価値 |
| **既存ポジション** | 活用しない | 最大限活用 |
| **リバランス効果** | 限定的 | 大幅改善 |
| **資金効率** | 低い | 高い |
| **実用性** | 低い | 高い |

#### 具体的な効果例
- **従来方式**: 利用可能資金$101.10 → 購入可能銘柄0銘柄
- **改善方式**: 総資産価値$13,302.10 → 購入可能銘柄4銘柄

### 🎯 今後の改善予定

1. **リバランス戦略の多様化**: より詳細なリバランス戦略
2. **リバランス頻度の自動調整**: 市場状況に応じた自動調整
3. **パフォーマンス監視**: リバランス効果の測定
4. **リスク管理強化**: より高度なリスク制御機能

---

## v1.4.0 - Docker対応とアカウントID自動取得機能の追加

### 🚀 新機能

#### 1. Docker対応
- **Dockerfile追加**: 環境に依存しない実行環境を提供
- **Docker実行**: `docker run --rm -v $(pwd):/app webullbot python3 run_rebalancing.py`
- **環境統一**: 異なるOS間での動作の一貫性を確保

#### 2. アカウントID自動取得機能
- **自動取得**: `account_id`、`subscription_id`、`user_id`を自動取得
- **設定簡素化**: 手動での設定ファイル更新が不要
- **エラーハンドリング**: 取得失敗時の適切なエラー処理

#### 3. マルチアカウント対応
- **簡単切り替え**: 設定ファイルの更新だけで新しいアカウントに変更可能
- **自動設定更新**: 実行時に必要な情報を自動保存
- **設定ファイル管理**: アカウント情報の一元管理

### 🔧 技術的改善

#### 1. コード統合
- **`get_account_id_from_api()`**: APIからアカウント情報を取得
- **`save_config()`**: 設定ファイルの自動保存
- **`ensure_account_id()`**: アカウントIDの確認と自動取得
- **初期化時の自動実行**: `__init__`メソッドで自動的にアカウントIDを取得

#### 2. エラーハンドリングの改善
- **アカウントID確認**: 各API呼び出し前にアカウントIDの存在確認
- **詳細ログ**: デバッグレベルのログ出力
- **エラー回復**: 自動取得失敗時の適切なエラーメッセージ

#### 3. 設定ファイルの改善
- **必須項目の明確化**: 手動設定が必要な項目と自動取得される項目の区別
- **デフォルト値**: 安全なデフォルト設定
- **バリデーション**: 設定値の検証機能

### 📝 ドキュメント更新

#### 1. README.md
- **Docker使用方法**: Dockerでの実行手順を追加
- **アカウント設定**: 必要な情報の取得方法を詳細に記載
- **トラブルシューティング**: 新しい機能に関する問題解決方法を追加
- **設定例**: 実際のアカウント情報の例を提供

#### 2. 設定ファイル例
- **必要な情報**: ユーザーID、パスワード、APIキー、APIシークレット、口座番号
- **自動取得情報**: Account ID、Subscription ID、User ID
- **アカウント変更手順**: 新しいアカウントへの切り替え方法

### 🧪 テスト済み機能

#### 1. アカウント切り替えテスト
- **アカウント1**: `08040224131` (CJP0871702)
  - Account ID: `1099757484888625152`
  - 口座残高: $101.10 USD
  - 既存ポジション: NUGT, SIL, PLTR

- **アカウント2**: `08040040157` (CJP0837276)
  - Account ID: `1074641578956013568`
  - 口座残高: $30,523.36 USD
  - ポジション: なし

#### 2. 機能テスト結果
- ✅ アカウントID自動取得
- ✅ 設定ファイル自動更新
- ✅ 口座残高取得
- ✅ ポジション取得
- ✅ 価格取得
- ✅ リバランシング計算
- ✅ ドライラン実行

### 🔄 変更されたファイル

#### 1. 新規ファイル
- `Dockerfile`: Dockerコンテナの定義
- `CHANGELOG.md`: このファイル

#### 2. 更新されたファイル
- `webull_complete_rebalancer.py`: アカウントID自動取得機能を統合
- `README.md`: Docker使用方法とアカウント設定情報を追加
- `webull_config_with_allocation.json`: 設定例の更新

#### 3. 削除されたファイル
- `get_account_id.py`: 機能がメインプログラムに統合されたため削除

### 📋 使用方法

#### 1. 新しいアカウントの設定
```json
{
  "username": "新しいユーザーID",
  "password": "新しいパスワード",
  "app_key": "新しいAPIキー",
  "app_secret": "新しいAPIシークレット",
  "account_id": "",
  "account_number": "新しい口座番号",
  "subscription_id": "",
  "user_id": "",
  "access_token": "",
  "refresh_token": ""
}
```

#### 2. Docker実行
```bash
# ドライラン
docker run --rm -v $(pwd):/app webullbot python3 run_rebalancing.py

# 実際の取引（dry_run: false に変更後）
docker run --rm -v $(pwd):/app webullbot python3 run_rebalancing.py
```

### 🎯 今後の改善予定

1. **Web UI**: ブラウザベースの設定画面
2. **スケジューリング**: 定期的な自動実行機能
3. **通知機能**: 取引結果の通知
4. **バックテスト**: 過去データでの戦略検証
5. **リスク管理**: より高度なリスク制御機能

### 📝 設定の最適化

#### 保守的価格マージンの初期設定
- **初期値**: `0.0` (0%)
- **理由**: 価格取得から実際の取引までの時間差が少ないため
- **効果**: 最大の購入数量を確保し、資金効率を最大化

---

## 以前のバージョン

### v1.3.0 - ログ機能の改善
- 詳細ログ機能の追加
- エラーログの改善

### v1.2.0 - クロスプラットフォーム対応
- Windows対応
- バッチファイルの追加

### v1.1.0 - 安全機能の追加
- 買付余力チェック
- 注文監視機能

### v1.0.0 - 初期リリース
- 基本的なリバランシング機能
- Webull API統合 